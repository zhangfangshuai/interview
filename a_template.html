<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template-Page</title>
</head>

<body>
    <h2>Relase-Subscribe-Module - 发布订阅者模式</h2>
    <div style="width: 100%; height: 2px; background: #F5F5F5;"></div>
    <ul>
        <li>什么是闭包？</li>

        <li>原型，原型对象，原型链, 构造函数</li>

        <li>什么是发布订阅者模式 <small>设计模式-核心 Vue2.x/3.x</small></li>

        <li>什么是观察者模式</li>
    </ul>
    <script>
        // 发布者 <----- 观察者

        /**
         * @func 观察者模式
         * @desc 成员： 发布者，观察者
         * @desc 使用： 发布者发布消息，订阅者执行订阅事件 
         */

        class Releaser {
            constructor() {
                this.watcherHub = []
            }
            addWatcher(watcher) {
                if (watcher && watcher.update) {
                    this.watcherHub.push(watcher)
                }
            }
            release(msg) {
                this.watcherHub.forEach(watcher => {
                    // fn.apply(this, [msg])
                    watcher.update.apply(this, [msg])
                })
            }
        }

        class Watcher {
            constructor() {}
            update(msg) {
                console.log(100, msg)
            }
        }

        // 使用
        let r1 = new Releaser()
        let w1 = new Watcher()
        
        r1.addWatcher(w1)

        // r1.release('发布消息11111')


        


        // 发布者 ---> 消息中心(订阅号) <--- 订阅者
        /**
         * @func 发布订阅者模式
         * @desc 成员： 发布者，订阅者，消息中心
         * @desc 使用： 发布者发布消息，消息中心收集消息，消息中心推送消息给订阅者 
         */
        let Event = function() {
            this.eventHub = {} // 消息中心 (中介)
        }

        Event.prototype = {
            // 添加订阅者
            subscribe(key, fn) {
                (this.eventHub[key] || (this.eventHub[key] = [])).push(fn)
            },
            // 添加发布者
            release() {
                // console.log(Object.values(arguments)[0])
                // let [ key1, ...args ] = arguments // Es6
                let key = Array.prototype.shift.call(arguments),  // Es5
                    fns = this.eventHub[key];
                if (!fns || fns.length === 0) return
                fns.forEach(fn => {
                    fn.apply(this, arguments)
                })
            },
            // 移除订阅者
            remove(key, fn) {
                let fns = this.eventHub[key]
                if (!fns || fns.length === 0) return
                // 产品思维： 1）批量移除； 2）指定移除
                if (!fn) {
                    this.eventHub[key].length = 0
                } else {
                    // 移除指定的订阅者
                    for (let i = fns.length - 1; i >= 0; i--) {
                        let _fn = fns[i]
                        (_fn === fn) && (this.eventHub[key].splice(i, 1))
                    }
                }
            }
        }



        // 使用
        let e1 = new Event()
        let e2 = new Event()


        e1.subscribe('a', function(msg) {
            console.log('订阅者订阅了a事件', msg)
        })
        e1.subscribe('b', function(msg) {
            console.log('订阅者订阅了b事件', msg)
        })
        e2.subscribe('d', function(msg) {
            console.log('订阅者订阅了b事件', msg)
        })
        e2.subscribe('e', function(msg) {
            console.log('订阅者订阅了b事件', msg)
        })

        e1.release('a', '天上掉馅饼了')
        e1.release('b', '天上掉馅饼了')


       

        let Event = (function() {
            this.eventHub = {} // 私有变量
            function subscribe() {
                console.log(this.eventHub)
            }
            function relese() {}
            function remove() {}

            return {
                subscribe,
                relese,
                remove
            }
        })()



        // 匿名自执行函数 jQuery  - 闭包
        (function(window) {
            
            function $(selector) {
                document.querySelectorAll(selector)
            }

            return $
        })(window)

        $('p').innerText() // smart
    </script>
</body>
</html>
